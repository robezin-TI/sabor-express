<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Sabor Express – Otimizador de Rotas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Leaflet Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- ML-KMeans -->
  <script src="https://cdn.jsdelivr.net/npm/ml-kmeans@4.1.0/dist/ml-kmeans.min.js"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #map { height:100%; width:75%; float:right; }
    #sidebar {
      width:25%; height:100%; float:left; overflow:auto;
      border-right:1px solid #ccc; padding:10px; box-sizing:border-box;
    }
    h2 { font-size:1.2em; margin-top:0; }
    ul { list-style:none; padding:0; }
    li { padding:5px; margin:5px 0; background:#f4f4f4;
         display:flex; justify-content:space-between; align-items:center; }
    .btn { display:block; margin:5px 0; padding:8px; border:none;
           background:#2563eb; color:#fff; border-radius:4px; cursor:pointer; }
    .btn:hover { background:#1e40af; }
    .handle { cursor:grab; margin-right:10px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Paradas</h2>
    <ul id="stopList"></ul>
    <div class="actions">
      <button class="btn" onclick="optimizeRoute()">Otimizar rota</button>
      <button class="btn" onclick="clearAll()">Limpar tudo</button>
    </div>
  </div>
  <div id="map"></div>

<script>
  const map = L.map('map').setView([-23.55, -46.63], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution:'© OpenStreetMap'
  }).addTo(map);

  let stops = [];
  let routeControl = null;
  const stopList = document.getElementById("stopList");

  // Cria letra A, B, C...
  function letter(index) {
    return String.fromCharCode(65 + index);
  }

  // Atualiza lista lateral
  function renderList(){
    stopList.innerHTML = "";
    stops.forEach((s,i)=>{
      const li = document.createElement("li");
      li.innerHTML = `<span class="handle">☰</span>${letter(i)} - ${s.lat.toFixed(4)}, ${s.lng.toFixed(4)}`;
      stopList.appendChild(li);
    });

    // Ativa drag&drop
    new Sortable(stopList, {
      handle: ".handle",
      animation: 150,
      onEnd: evt=>{
        const from = evt.oldIndex, to = evt.newIndex;
        if(from===to) return;
        const moved = stops.splice(from,1)[0];
        stops.splice(to,0,moved);
        updateMarkers();
        drawRoute();
      }
    });
  }

  // Adiciona parada
  function addStop(latlng){
    const marker = L.marker(latlng).addTo(map);
    stops.push({lat:latlng.lat, lng:latlng.lng, marker});
    updateMarkers();
    renderList();
    drawRoute();
  }

  // Atualiza letras nos marcadores
  function updateMarkers(){
    stops.forEach((s,i)=>{
      s.marker.setIcon(L.divIcon({
        className:'', html:`<b>${letter(i)}</b>`,
        iconSize:[20,20], iconAnchor:[10,10]
      }));
    });
  }

  // Desenha rota
  function drawRoute(){
    if(routeControl) map.removeControl(routeControl);
    if(stops.length < 2) return;
    const waypoints = stops.map(s=>L.latLng(s.lat,s.lng));
    routeControl = L.Routing.control({
      waypoints,
      router: L.Routing.osrmv1({serviceUrl:"https://router.project-osrm.org/route/v1"}),
      createMarker: ()=>null, addWaypoints:false, draggableWaypoints:false
    }).addTo(map);
  }

  // Otimizar via OSRM Trip API
  async function optimizeRoute(){
    if(stops.length<3) return alert("Adicione pelo menos 3 pontos.");
    const coords = stops.map(s=>`${s.lng},${s.lat}`).join(";");
    const url = `https://router.project-osrm.org/trip/v1/driving/${coords}?source=first&roundtrip=false&annotations=duration,distance`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data.trips || !data.trips[0]) return alert("Erro na otimização");
    const order = data.waypoints.map(w=>w.waypoint_index);
    stops = order.map(i=>stops[i]);
    updateMarkers(); renderList(); drawRoute();
  }

  // Limpar tudo
  function clearAll(){
    stops.forEach(s=>map.removeLayer(s.marker));
    stops=[]; renderList();
    if(routeControl) map.removeControl(routeControl);
  }

  // Clique no mapa adiciona ponto
  map.on("click", e=>addStop(e.latlng));

  // === K-MEANS CLUSTERING ===
  async function clusterize(k=2){
    if(stops.length < k) { alert("Poucos pontos para clusterizar"); return; }

    const data = stops.map(s => [s.lat, s.lng]);
    const { clusters } = mlKMeans(data, k);

    // Remove marcadores antigos
    stops.forEach(s => map.removeLayer(s.marker));

    const colors = ["#2563eb","#10b981","#f59e0b","#ef4444","#8b5cf6","#14b8a6","#d946ef"];

    // Redesenha com cor de cluster
    clusters.forEach((c,i)=>{
      const s=stops[i]; const color=colors[c%colors.length];
      const marker=L.marker([s.lat,s.lng],{
        icon:L.divIcon({
          className:"", html:`<b style="color:${color}">${letter(i)}</b>`,
          iconSize:[20,20], iconAnchor:[10,10]
        })
      }).addTo(map);
      s.marker=marker; s.cluster=c;
    });

    // Agrupa por cluster e desenha rotas
    const grouped={};
    clusters.forEach((c,i)=>{
      if(!grouped[c]) grouped[c]=[];
      grouped[c].push(stops[i]);
    });

    Object.values(grouped).forEach(group=>{
      if(group.length>1){
        const waypoints=group.map(s=>L.latLng(s.lat,s.lng));
        L.Routing.control({
          waypoints,
          router:L.Routing.osrmv1({serviceUrl:"https://router.project-osrm.org/route/v1"}),
          addWaypoints:false, draggableWaypoints:false,
          fitSelectedRoutes:false, createMarker:()=>null,
          lineOptions:{styles:[{color:colors[group[0].cluster%colors.length],opacity:0.7,weight:5}]}
        }).addTo(map);
      }
    });
  }

  // Botão K-Means
  const btnCluster=document.createElement("button");
  btnCluster.textContent="Agrupar entregas (K-Means)";
  btnCluster.className="btn";
  btnCluster.onclick=()=>{
    const k=prompt("Quantos clusters deseja formar?","2");
    if(k) clusterize(parseInt(k));
  };
  document.querySelector(".actions").appendChild(btnCluster);
</script>
</body>
</html>
